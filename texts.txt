#!/usr/bin/env python3
"""
rotina_api.py
1. Faz login via POST e obtém token.
2. Usa o token em outra requisição GET com Authorization Bearer.
3. Salva resposta JSON em /data e erros em /errors.
"""

import requests
import json
from datetime import datetime, timezone
from pathlib import Path
import traceback

# ---------------- CONFIGURAÇÃO ----------------
LOGIN_URL = "https://exemplo.com/api/login"           # URL do login
DATA_URL = "https://exemplo.com/api/dados"            # URL dos dados após login
OUTPUT_DIR = Path("data")                             # Pasta para salvar JSONs
ERROR_DIR = Path("errors")                            # Pasta para salvar erros
TIMEOUT = 20                                          # Timeout das requisições
KEEP_DAYS = 30                                        # (opcional) manter arquivos
# --------------------------------------------------

def ensure_dirs():
    """Cria as pastas data/ e errors/ caso não existam."""
    OUTPUT_DIR.mkdir(parents=True, exist_ok=True)
    ERROR_DIR.mkdir(parents=True, exist_ok=True)

def log_error(msg: str, exc: Exception = None):
    """Salva erro em arquivo .log na pasta errors/."""
    ts = datetime.now(timezone.utc).strftime("%Y%m%d_%H%M%S")
    filename = ERROR_DIR / f"erro_{ts}.log"
    with open(filename, "w", encoding="utf-8") as f:
        f.write(f"[{datetime.now(timezone.utc)}] {msg}\n")
        if exc:
            f.write(traceback.format_exc())
    print(f"Erro registrado em: {filename}")

def fazer_login():
    """Envia POST para obter token."""
    try:
        payload = {
            "usuario": "seu_usuario",
            "senha": "sua_senha"
        }
        print("Fazendo login...")
        resp = requests.post(LOGIN_URL, json=payload, timeout=TIMEOUT)
        resp.raise_for_status()

        data = resp.json()
        token = data.get("token") or data.get("access_token")

        if not token:
            raise ValueError("Token não encontrado na resposta de login.")

        print("Login bem-sucedido.")
        return token

    except Exception as e:
        log_error("Falha no login", e)
        raise

def consumir_dados(token: str):
    """Usa o token para acessar os dados protegidos."""
    try:
        headers = {
            "Authorization": f"Bearer {token}"
        }

        print("Consumindo dados...")
        resp = requests.get(DATA_URL, headers=headers, timeout=TIMEOUT)
        resp.raise_for_status()
        data = resp.json()
        print("Dados recebidos com sucesso.")
        return data

    except Exception as e:
        log_error("Falha ao consumir dados", e)
        raise

def salvar_json(data):
    """Salva os dados JSON na pasta data/ com timestamp."""
    ts = datetime.now(timezone.utc).strftime("%Y%m%d_%H%M%S")
    filename = OUTPUT_DIR / f"dados_{ts}.json"
    with open(filename, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)
    print(f"Arquivo salvo em: {filename}")

def main():
    ensure_dirs()
    try:
        token = fazer_login()
        dados = consumir_dados(token)
        salvar_json(dados)
    except Exception as e:
        print(f"Erro geral na rotina: {e}")
        # o log já é salvo em log_error()

if __name__ == "__main__":
    main()